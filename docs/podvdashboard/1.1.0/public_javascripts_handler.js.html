<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/javascripts/handler.js - Pod 5 Operators Dashboard Docs</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Batteries.html">Batteries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Batteries.html#~checkMinMax">checkMinMax</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~createRow">createRow</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~createTable">createTable</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~fillCell">fillCell</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~initBatteries">initBatteries</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~updateBattery">updateBattery</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~updateBatteryAndRender">updateBatteryAndRender</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~updateCell">updateCell</a></li><li data-type='method' style='display: none;'><a href="module-Batteries.html#~updateTemps">updateTemps</a></li></ul></li><li><a href="module-Button.html">Button</a></li><li><a href="module-Cache.html">Cache</a></li><li><a href="module-Communication.html">Communication</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Communication.html#.commandTorque">commandTorque</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.disableHV">disableHV</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.enableHV">enableHV</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.enPrecharge">enPrecharge</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.primBrakeOff">primBrakeOff</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.primBrakeOn">primBrakeOn</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.secBrakeOff">secBrakeOff</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.secBrakeOn">secBrakeOn</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendEBrake">sendEBrake</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendHVPing">sendHVPing</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendLVPing">sendLVPing</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendOverride">sendOverride</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendPropulse">sendPropulse</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendPumpDown">sendPumpDown</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendReadyCommand">sendReadyCommand</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.sendReadyPump">sendReadyPump</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.toggleLatch">toggleLatch</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#.toggleSafety">toggleSafety</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#~sendHVCommand">sendHVCommand</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#~sendLVCommand">sendLVCommand</a></li><li data-type='method' style='display: none;'><a href="module-Communication.html#~sendPacket">sendPacket</a></li></ul></li><li><a href="module-Config.html">Config</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Config.html#~getConstantsPath">getConstantsPath</a></li><li data-type='method' style='display: none;'><a href="module-Config.html#~getJSONFile">getJSONFile</a></li><li data-type='method' style='display: none;'><a href="module-Config.html#~readJSON">readJSON</a></li><li data-type='method' style='display: none;'><a href="module-Config.html#~updateConstants">updateConstants</a></li><li data-type='method' style='display: none;'><a href="module-Config.html#~writeJSON">writeJSON</a></li></ul></li><li><a href="module-Data-Interfacing.html">Data-Interfacing</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#.archiveData">archiveData</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#.createCache">createCache</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#.findRenderable">findRenderable</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#.normalizePacket">normalizePacket</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~ambientToGauge">ambientToGauge</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~calculate">calculate</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~createID">createID</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~createJSON">createJSON</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~getAbsoluteSpeed">getAbsoluteSpeed</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~getLVSOC">getLVSOC</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~getMaxMotorControllerTemp">getMaxMotorControllerTemp</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~getPackPowerRemaining">getPackPowerRemaining</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~getPowerConsumed">getPowerConsumed</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~interpolateLVSOC">interpolateLVSOC</a></li><li data-type='method' style='display: none;'><a href="module-Data-Interfacing.html#~updateData">updateData</a></li></ul></li><li><a href="module-Data-Recording.html">Data-Recording</a></li><li><a href="module-Dynamic-Loading.html">Dynamic-Loading</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#.fillAllItems">fillAllItems</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#.fillAllTables">fillAllTables</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~createActualCol">createActualCol</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~createHeaderCol">createHeaderCol</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~createMaxCol">createMaxCol</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~createMinCol">createMinCol</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~createRow">createRow</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~fillAllBounds">fillAllBounds</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~fillRowBounds">fillRowBounds</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~fillTable">fillTable</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~fillTableBounds">fillTableBounds</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~getMaxCell">getMaxCell</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~getMinCell">getMinCell</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~setMaxCell">setMaxCell</a></li><li data-type='method' style='display: none;'><a href="module-Dynamic-Loading.html#~setMinCell">setMinCell</a></li></ul></li><li><a href="module-Electron-app.html">Electron-app</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Electron-app.html#~createWindow">createWindow</a></li></ul></li><li><a href="module-Handler.html">Handler</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Handler.html#~autosave">autosave</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~checkBraking">checkBraking</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~checkPackets">checkPackets</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~checkRecieve">checkRecieve</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~checkTransmit">checkTransmit</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~createDashboard">createDashboard</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~displayTimer">displayTimer</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~init">init</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~podConnectionCheck">podConnectionCheck</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~renderData">renderData</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~sendHeartbeats">sendHeartbeats</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~setControlPanelListeners">setControlPanelListeners</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~setHVIndicator">setHVIndicator</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~setLVIndicator">setLVIndicator</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~setRecieve">setRecieve</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~togglePrimBrake">togglePrimBrake</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~toggleSecBrake">toggleSecBrake</a></li><li data-type='method' style='display: none;'><a href="module-Handler.html#~updateLabels">updateLabels</a></li></ul></li><li><a href="module-Highcharts.html">Highcharts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~addData">addData</a></li><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~addTimeAndData">addTimeAndData</a></li><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~clearChart">clearChart</a></li><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~newChart">newChart</a></li><li data-type='method' style='display: none;'><a href="module-Highcharts.html#~startChart">startChart</a></li></ul></li><li><a href="module-Main.html">Main</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Main.html#~clear">clear</a></li><li data-type='method' style='display: none;'><a href="module-Main.html#~clone">clone</a></li><li data-type='method' style='display: none;'><a href="module-Main.html#~fillConstants">fillConstants</a></li><li data-type='method' style='display: none;'><a href="module-Main.html#~searchTable">searchTable</a></li><li data-type='method' style='display: none;'><a href="module-Main.html#~toggleSettingsModal">toggleSettingsModal</a></li></ul></li><li><a href="module-Renderer.html">Renderer</a></li><li><a href="module-TestingTool.html">TestingTool</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~fillAllTables">fillAllTables</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~fillCell">fillCell</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~fillScrubber">fillScrubber</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~fillTable">fillTable</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~findMax">findMax</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~handleFiles">handleFiles</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~importJSON">importJSON</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~incrementTimer">incrementTimer</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~init">init</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~pauseTimer">pauseTimer</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~playTimer">playTimer</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~resetTimer">resetTimer</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~updateScrubber">updateScrubber</a></li><li data-type='method' style='display: none;'><a href="module-TestingTool.html#~updateTables">updateTables</a></li></ul></li><li><a href="module-TestPodServer.html">TestPodServer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~getRandomIntInclusive">getRandomIntInclusive</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~getRandomValue">getRandomValue</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~heartbeat">heartbeat</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendData">sendData</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendIncreasingData">sendIncreasingData</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendJSON">sendJSON</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendSinusodalData">sendSinusodalData</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendSpecificData">sendSpecificData</a></li><li data-type='method' style='display: none;'><a href="module-TestPodServer.html#~sendTestData">sendTestData</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="ControlPanelButton.html">ControlPanelButton</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ControlPanelButton.html#.getParent">getParent</a></li><li data-type='method' style='display: none;'><a href="ControlPanelButton.html#.setParent">setParent</a></li></ul></li><li><a href="Dropdown.html">Dropdown</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Dropdown.html#.createDropdown">createDropdown</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#.filterSearch">filterSearch</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#.getListOfDropdowns">getListOfDropdowns</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#createDropdownBtn">createDropdownBtn</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#createItem">createItem</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#fillList">fillList</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#onClick">onClick</a></li><li data-type='method' style='display: none;'><a href="Dropdown.html#toggle">toggle</a></li></ul></li><li><a href="module-Batteries-Battery.html">Battery</a></li><li><a href="module-Button-Button.html">Button</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-Button-Button.html#.setModalTemplate">setModalTemplate</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#.toggleConfirmationModal">toggleConfirmationModal</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#activate">activate</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#colorize">colorize</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#confirmActive">confirmActive</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#createNewElement">createNewElement</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#deactivate">deactivate</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#greyOut">greyOut</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#onClick">onClick</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#setParent">setParent</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#setText">setText</a></li><li data-type='method' style='display: none;'><a href="module-Button-Button.html#setTextColor">setTextColor</a></li></ul></li><li><a href="module-Renderer.html">Renderer</a></li><li><a href="State.html">State</a><ul class='methods'><li data-type='method' style='display: none;'><a href="State.html#.getActiveState">getActiveState</a></li><li data-type='method' style='display: none;'><a href="State.html#.getStateById">getStateById</a></li><li data-type='method' style='display: none;'><a href="State.html#.setActiveState">setActiveState</a></li><li data-type='method' style='display: none;'><a href="State.html#.toggleConfirmationModal">toggleConfirmationModal</a></li><li data-type='method' style='display: none;'><a href="State.html#activate">activate</a></li><li data-type='method' style='display: none;'><a href="State.html#confirmActive">confirmActive</a></li><li data-type='method' style='display: none;'><a href="State.html#setActive">setActive</a></li><li data-type='method' style='display: none;'><a href="State.html#setInactive">setInactive</a></li></ul></li><li><a href="StateButton.html">StateButton</a><ul class='methods'><li data-type='method' style='display: none;'><a href="StateButton.html#activate">activate</a></li><li data-type='method' style='display: none;'><a href="StateButton.html#deactivate">deactivate</a></li><li data-type='method' style='display: none;'><a href="StateButton.html#onClick">onClick</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#decrementTorqueValue">decrementTorqueValue</a></li><li><a href="global.html#incrementTorqueValue">incrementTorqueValue</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">public/javascripts/handler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module Handler
 * @author Eric Udlis, Michael Handler
 * @description Handle all updates and interfacing between the front-end and back-end
 */
const CLIENT = require('./public/javascripts/communication');
const DATA_INTERFACING = require('./public/javascripts/datainterfacing');
const COMMUNICATIONS_EMITTER = require('./public/javascripts/communication').recievedEmitter;
const CONSTANTS = require('./constants');
const DYNAMIC_LOADING = require('./public/javascripts/dynamicloading');
const RENDERER = require('./public/javascripts/renderer');
const TIMER = require('./public/javascripts/Timer');
const CACHE = require('./cache');
const DATA_RECORDING = require('./dataRecording');

// New OOP stuff
const State = require('./public/javascripts/State');
const ControlPanelButton = require('./public/assets/ControlPanelButton');

const D = document;
const TIMEOUT = 5000;
const CONNECTION_CHECK_INTERVAL = 1000;
const AUTOSAVE_INTERVAL = 30000;
const STATE_BUTTONS = [['Power Off', '#C10000'], ['Idle', '#3C9159'],
  ['Pumpdown', '#C66553', true], ['Propulsion', '#C6A153', true], ['Braking', '#34495E'],
  ['Stopped', '#34495E'], ['Crawl Precharge', '#C6A153'], ['Crawl', '#A84671', true],
  ['Post Run', '#34495E'], ['Safe to Approach', '#3C9159'],
  ['Run Fault', 'red', false, true], ['Non-Run Fault', 'red', false, true]];
  // [Display Name, btn color, ishazardous, isFault]
ControlPanelButton.setParent(document.getElementById('controlpanelBox'));
const CONFIRMATION_MODAL = D.querySelector('.confirmationModal');
ControlPanelButton.setModalTemplate(CONFIRMATION_MODAL);

const LV_INDICATOR = D.getElementById('connectionDot1');
const HV_INDICATOR = D.getElementById('connectionDot2');
const RECIEVE_INDICATOR_1 = D.getElementById('link1');
const RECIEVE_INDICATOR_2 = D.getElementById('link2');
const DATA_RECORD_BUTTON = new ControlPanelButton('dataRecord', 'Start Data Recording', '#AEA8D3', false);
const ARCHIVE_BUTTON = new ControlPanelButton('archiveData', 'Save Data Recording', '#AEA8D3', false);
ARCHIVE_BUTTON.greyOut();
const COMMAND_TORQUE = new ControlPanelButton('cmdTorque', 'Cmd Torque', '#F4D76F', true);
const PRIMARY_BRAKE_ON = new ControlPanelButton('primBrakeOn', 'Prim. Brake Act', '#34495E', false);
const PRIMARY_BRAKE_OFF = new ControlPanelButton('primBrakeOff', 'Prim. Brake Retr', '#34495E', false);
const PRECHARGE_ENABLE = new ControlPanelButton('precharge', 'Precharge', '#C6A153', true);
const SECONDARY_BRAKE_ON = new ControlPanelButton('secBrakeOff', 'Sec. Brake Act', '#5C97BF', false);
const SECONDARY_BRAKE_OFF = new ControlPanelButton('secBrakeOn', 'Sec. Brake Retr', '#5C97BF', false);
const LATCH_ON = new ControlPanelButton('latchOn', 'Latch On', '#554188', true);
const HV_ENABLE = new ControlPanelButton('hvEnable', 'HV Enable', '#F4D76F', true);
const HV_DISABLE = new ControlPanelButton('hvDisable', 'HV Disable', '#F4D76F', false);
const LATCH_OFF = new ControlPanelButton('latchOff', 'Latch off', '#554188', true);

const EMERGENCY_STOP_BTN = D.getElementById('estop');
const TABLES_RENDERER = new RENDERER();
const GLOBAL_TIMER = new TIMER();
const { stateTimer: STATE_TIMER } = DYNAMIC_LOADING;

let activeTimer = GLOBAL_TIMER;
let { DEBUG } = Boolean(process.env) || false;
let boneStatus = [false, false]; // [LV, HV]
let packetCounts = [0, 0]; // [LV, HV]
// eslint-disable-next-line no-unused-vars
let oldCounts = [0, 0];


/**
 * @param  {String} group Group the sensor belongs to
 * @param  {String} sensor Sensor to modify
 */
// Renders latest entry in cace to the tables
function renderData(group, sensor) {
  // Get numbers
  const t = D.getElementById(String(sensor));
  const stored = CACHE[group][sensor];
  // Set number
  if (stored[stored.length - 1] == null) {
    t.innerHTML = 'Not Available';
  } else {
    t.innerHTML = String(stored[stored.length - 1]);
  }
}

// State Machine Control Panel Event Listeners
/**
 * Creates a JSON save labled "Autosave"
 */
function autosave() {
  DATA_INTERFACING.archiveData('autosave');
}

/**
 * Toggles the primary braking indicators and calls the
 * communication call if noted by call
 * @param {Boolean} state // True for on, false for off
 * @param {Boolean} call
 */
function togglePrimBrake(state, call) {
  if (state) {
    PRIMARY_BRAKE_ON.activate();
    PRIMARY_BRAKE_OFF.deactivate();
    if (call) CLIENT.primBrakeOn();
  }
  if (!state) {
    PRIMARY_BRAKE_OFF.activate();
    PRIMARY_BRAKE_ON.deactivate();
    if (call) CLIENT.primBrakeOff();
  }
}
/**
 * Toggles the secondary braking indicators and calls the
 * communication call if noted by call
 * @param {Boolean} state // True for on, false for off
 * @param {Boolean} call
 */
function toggleSecBrake(state, call) {
  if (state) {
    SECONDARY_BRAKE_ON.activate();
    SECONDARY_BRAKE_OFF.deactivate();
    if (call) CLIENT.secBrakeOn();
  }
  if (!state) {
    SECONDARY_BRAKE_ON.deactivate();
    SECONDARY_BRAKE_OFF.activate();
    if (call) CLIENT.secBrakeOff();
  }
}
/**
 * Checks packet for primary and seconday braking status
 * changes indicators and deletes flags
 * @param {Object} basePacket The original packet
 * @returns {Object} fixedPacket The modified packet
 */
function checkBraking(basePacket) {
  let fixedPacket = basePacket;
  if (basePacket.braking !== undefined) {
    if (basePacket.braking.primBrake === 1) togglePrimBrake(false, false);
    else togglePrimBrake(true, false);
    if (basePacket.braking.secBrake === 1) toggleSecBrake(false, false);
    else toggleSecBrake(true, false);
    delete fixedPacket.braking.primBrake;
    delete fixedPacket.braking.secBrake;
  }
  return fixedPacket;
}

// Connection Indicators
/**
 * Sets recieve indicators and starts/stops timer based on status
 * @param {Boolean} state true for ok false for bad
 */
function setRecieve(state) {
  if (state) {
    RECIEVE_INDICATOR_1.className = 'statusGood';
    RECIEVE_INDICATOR_2.className = 'statusGood';
    D.getElementById('ageDisplay').className = 'statusGood';
    if (!GLOBAL_TIMER.process) {
      GLOBAL_TIMER.start();
    }
  }
  if (!state) {
    RECIEVE_INDICATOR_1.className = 'statusBad';
    RECIEVE_INDICATOR_2.className = 'statusBad';
    D.getElementById('ageDisplay').innerHTML = 'N/A';
    D.getElementById('ageDisplay').className = 'statusBad';
    GLOBAL_TIMER.reset();
  }
}
/**
 * Displays the given timer in defined display location
 * @param {Timer} timer Displays the timers current time
 */
function displayTimer(timer) {
  if (`${timer.getSeconds()}`.length === 1) D.getElementById('ageDisplay').innerHTML = `${timer.getMinutes()}:0${timer.getSeconds()}`;
  else D.getElementById('ageDisplay').innerHTML = `${timer.getMinutes()}:${timer.getSeconds()}`;
}
/**
 * Sets the LV indicator
 * @param {Boolean} state true for ok false for bad
 */
function setLVIndicator(state) {
  if (state) LV_INDICATOR.className = 'statusGood';
  if (!state) LV_INDICATOR.className = 'statusBad';
}
/**
 *Sets the HV indicator
 * @param {Boolean} state true for ok false for bad
 */
function setHVIndicator(state) {
  if (state) HV_INDICATOR.className = 'statusGood';
  if (!state) HV_INDICATOR.className = 'statusBad';
  if (!state &amp;&amp; !DEBUG) State.setActiveState(0, CONFIRMATION_MODAL);
}
/**
 * Checks if dashboard has recieved packets within timeout period
 * If so, sets recieve indicator good and renders to tables
 * If bad,sets recieve indicator bad and stops rendering to tables
 */
function checkRecieve() {
  let now = new Date().getTime();
  let difference = now - TABLES_RENDERER.lastRecievedTime;
  displayTimer(activeTimer);
  // console.log(`now: ${now} difference ${difference} timeout ${TIMEOUT}`);
  if ((difference > TIMEOUT) || TABLES_RENDERER.lastRecievedTime === 0) {
    setRecieve(false);
    TABLES_RENDERER.stopRenderer();
  } else {
    setRecieve(true);
    TABLES_RENDERER.startRenderer();
  }
}
/**
 * Sends TCP heartbeats to Pod
 */
function sendHeartbeats() {
  CLIENT.sendLVPing();
  CLIENT.sendHVPing();
}

/**
 * Sets LV and HV indicators based on boneStatus
 */
function checkTransmit() {
  setLVIndicator(boneStatus[0]);
  setHVIndicator(boneStatus[1]);
}

/**
 * Updates lables of tables based on recieving packets or not
 */
function updateLabels() {
  if (oldCounts[0] &lt; packetCounts[0] + 5) {
    // Still Recieving packets
    D.getElementById('motionDisconnected').style.display = 'none';
    D.getElementById('brakingDisconnected').style.display = 'none';
  } else {
    // Haven't recieved packets
    D.getElementById('motionDisconnected').style.display = 'inline';
    D.getElementById('brakingDisconnected').style.display = 'inline';
  }
  if (oldCounts[1] &lt; packetCounts[1] + 5) {
    // Still recieving packets
    D.getElementById('motorDisconnected').style.display = 'none';
    D.getElementById('batteryDisconnected').style.display = 'none';
  } else {
    // Haven't recieved packets
    D.getElementById('motorDisconnected').style.display = 'inline';
    D.getElementById('batteryDisconnected').style.display = 'inline';
  }
  oldCounts[0] = packetCounts[0];
  oldCounts[1] = packetCounts[1];
  /** ***************************
  // return null;
   ***************************** */
}
/**
 * Checks if recieving packets, sends heartbeats to pod, checks if we get call back from pod
 * Updates Table Lables
 */
function podConnectionCheck() {
  checkRecieve();
  sendHeartbeats();
  checkTransmit();
  updateLabels();
}
/**
 * Checks weather given packet is a HV or LV packet and increments counter accordingly
 * @param {Object} input Packet to check
 */
function checkPackets(input) {
  if (input.braking &amp;&amp; input.motion) packetCounts[0]++;
  if (input.motor &amp;&amp; input.battery) packetCounts[1]++;
}


// Event Listeners
// Changes timer based on user input
document.getElementById('ageDisplay').addEventListener('click', () => {
  if (activeTimer === GLOBAL_TIMER) {
    document.getElementById('ageLabel').innerHTML = 'State Timer';
    activeTimer = STATE_TIMER;
    return;
  }
  if (activeTimer === STATE_TIMER || propTimer) {
    document.getElementById('ageLabel').innerHTML = 'Global Timer';
    activeTimer = GLOBAL_TIMER;
  }
});

// Sends Estop on user click
EMERGENCY_STOP_BTN.addEventListener('click', () => {
  CLIENT.sendEBrake();
});


// Initilization
/**
 * Creates the states and state machine buttons
 */

function setControlPanelListeners() {
  PRIMARY_BRAKE_ON.onClick(() => {
    togglePrimBrake(true, true);
  });

  PRIMARY_BRAKE_OFF.onClick(() => {
    togglePrimBrake(false, true);
  });

  SECONDARY_BRAKE_ON.onClick(() => {
    toggleSecBrake(true, true);
  });

  SECONDARY_BRAKE_OFF.onClick(() => {
    toggleSecBrake(false, true);
  });

  HV_ENABLE.onClick(() => {
    CLIENT.enableHV();
    HV_DISABLE.deactivate();
    HV_ENABLE.activate();
  });

  HV_DISABLE.onClick(() => {
    CLIENT.disableHV();
    HV_DISABLE.activate();
    HV_ENABLE.deactivate();
  });

  COMMAND_TORQUE.onClick(() => {
    CLIENT.commandTorque();
  });

  LATCH_ON.onClick(() => {
    LATCH_ON.activate();
    LATCH_OFF.deactivate();
    CLIENT.toggleLatch(true);
  });

  LATCH_OFF.onClick(() => {
    LATCH_OFF.activate();
    LATCH_ON.deactivate();
    CLIENT.toggleLatch(false);
  });

  PRECHARGE_ENABLE.onClick(() => {
    CLIENT.enPrecharge();
  });

  // Starts the recording of data to dataRecording.js
  DATA_RECORD_BUTTON.onClick(() => {
    if (!DATA_INTERFACING.isDataRecording) {
      DATA_INTERFACING.recordingEvent.emit('on'); // Tell DI to run start recording data
      console.log('recording data');
      DATA_RECORD_BUTTON.greyOut();
      ARCHIVE_BUTTON.colorize();
    } else {
      console.log('data is already being recorded');
    }
  });

  // Archives the data from dataRecording.js if data is being recorded
  ARCHIVE_BUTTON.onClick(() => {
    if (DATA_INTERFACING.isDataRecording) {
      DATA_INTERFACING.recordingEvent.emit('off'); // Tells DI to stop recording data
      DATA_INTERFACING.archiveData();
      console.log('archiving data');
      DATA_RECORD_BUTTON.colorize();
      ARCHIVE_BUTTON.greyOut();
    } else {
      console.log('data was not being recorded');
    }
  });
}
function createStateMachineButtons() {
  return new Promise((resolve, reject) => {
    let parent = document.getElementById('statemachineBox');
    if (!parent) reject(new Error('Parent not found'));
    STATE_BUTTONS.forEach((state) => {
      let formattedText = state[0].replace(/ /g, '').toLowerCase();
      let newState = new State(formattedText, state[0], null, state[1], state[2], state[3]);
      newState.btn.setParent(parent);
      newState.btn.onClick(() => {
        State.setActiveState(newState, CONFIRMATION_MODAL);
      });
    });
    State.setActiveState(0);
    resolve(State.getActiveState());
  });
}

/**
 * Function to create the caches and tables and dropdowns of the dash
 */
function createDashboard() {
  return new Promise((resolve, reject) => {
    try {
      DATA_INTERFACING.createCache();
      DATA_INTERFACING.createCache(DATA_RECORDING);
      DYNAMIC_LOADING.fillAllItems();
      DYNAMIC_LOADING.fillAllTables();
    } catch (e) {
      reject(new Error(e));
    }
    resolve();
  });
}

/**
 * Function to run at start of dashboard
 */
function init() {
  createDashboard().then(() => { // First create the dashboard
    setControlPanelListeners();
    createStateMachineButtons().then(() => { // Then create all the state objects
      setInterval(podConnectionCheck, CONNECTION_CHECK_INTERVAL); // Finally set intervals
      // Autosaves on interval
      setInterval(autosave, AUTOSAVE_INTERVAL);
    }).catch((err) => {
      throw err;
    });
  });
  displayTimer(GLOBAL_TIMER);
  console.log(DEBUG);
}
// Run at init
init();

// Events

// Data in recieved
COMMUNICATIONS_EMITTER.on('dataIn', (input) => {
  if (DEBUG) console.log(input);
  checkPackets(input);
  let fixedPacket = checkBraking(input);
  DATA_INTERFACING.normalizePacket(fixedPacket);
  TABLES_RENDERER.lastRecievedTime = new Date().getTime();
});

COMMUNICATIONS_EMITTER.on('Lost', (ip) => {
  if (ip === CONSTANTS.lvBone.ip) {
    if (boneStatus[0]) console.error('lost LV bone');
    boneStatus[0] = false;
  }
  if (ip === CONSTANTS.hvBone.ip) {
    if (boneStatus[1]) console.error('lost LV bone');
    boneStatus[1] = false;
  }
});

COMMUNICATIONS_EMITTER.on('ok', (ip) => {
  if (ip === CONSTANTS.lvBone.ip) { boneStatus[0] = true; }
  if (ip === CONSTANTS.hvBone.ip) { boneStatus[1] = true; }
});

DATA_INTERFACING.packetHandler.on('renderData', () => {
  const renderable = DATA_INTERFACING.findRenderable();
  const groups = Object.keys(renderable);
  groups.forEach((group) => {
    const sensors = Object.keys(renderable[group]);
    sensors.forEach((sensor) => {
      // Check to see if that particular sensor is being rendered at the time
      try {
        renderData(group, sensor);
      } catch (error) {
        // If not, alert the user and move on
        console.error(`Error: Sensor ${sensor} in ${group} not rendered`);
      }
    });
  });
});
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Apr 15 2020 16:15:54 GMT-0500 (Central Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
